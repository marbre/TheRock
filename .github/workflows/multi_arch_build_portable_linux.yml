# Multi-Arch Build - Sharded Pipeline for Linux
#
# This workflow builds TheRock in stages:
# 1. foundation (generic) - sysdeps, base
# 2. compiler-runtime (generic) - compiler, runtimes, profiler-core
# 3. math-libs (per-arch) - BLAS, FFT, etc.
# 4. comm-libs (per-arch) - RCCL (parallel to math-libs)
# 5. debug-tools (generic) - amd-dbgapi, rocr-debug-agent, rocgdb (parallel to math-libs)
# 6. dctools-core (generic) - RDC (parallel to math-libs)
# 7. profiler-apps (generic) - rocprofiler-systems (parallel to math-libs)
# 8. media (generic) - sysdeps-amd-mesa, rocdecode (todo), rocjpeg (todo)
#
# Artifacts flow between stages via S3 using the artifact_manager.py tool.
#
# TODO: When kpack splitting is permanently enabled, change fetch commands to use
# --generic-only instead of --amdgpu-families for efficiency. Subsequent build
# stages only need generic (host) artifacts; device-specific kpacks are not
# needed until final packaging.

name: Multi-Arch Build (Linux)

on:
  workflow_call:
    inputs:
      artifact_group:
        type: string
      matrix_per_family_json:
        type: string
        description: "JSON array of {amdgpu_family, test-runs-on} objects for per-arch stages"
      dist_amdgpu_families:
        type: string
        description: "Semicolon-separated list of all GPU families for dist targets"
      build_variant_label:
        type: string
      build_variant_cmake_preset:
        type: string
      build_variant_suffix:
        type: string
      test_labels:
        type: string
      artifact_run_id:
        type: string
      expect_failure:
        type: boolean
      use_prebuilt_artifacts:
        type: string
      rocm_package_version:
        type: string
      test_type:
        type: string

permissions:
  contents: read


jobs:
  # ==========================================================================
  # STAGE: foundation (generic)
  # ==========================================================================
  foundation:
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: foundation
      stage_display_name: "Stage - Foundation"
      timeout_minutes: 180  # 3 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: compiler-runtime (generic)
  # ==========================================================================
  compiler-runtime:
    needs: foundation
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: compiler-runtime
      stage_display_name: "Stage - Compiler Runtime"
      timeout_minutes: 480  # 8 hours (compiler is big)
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: math-libs (per-arch)
  # ==========================================================================
  math-libs:
    needs: compiler-runtime
    strategy:
      fail-fast: false
      matrix:
        family_info: ${{ fromJSON(inputs.matrix_per_family_json) }}
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: math-libs
      stage_display_name: "Stage - Math Libs (${{ matrix.family_info.amdgpu_family }})"
      timeout_minutes: 480  # 8 hours
      amdgpu_family: ${{ matrix.family_info.amdgpu_family }}
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: comm-libs (per-arch, parallel to math-libs)
  # ==========================================================================
  comm-libs:
    needs: compiler-runtime
    strategy:
      fail-fast: false
      matrix:
        family_info: ${{ fromJSON(inputs.matrix_per_family_json) }}
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: comm-libs
      stage_display_name: "Stage - Comm Libs (${{ matrix.family_info.amdgpu_family }})"
      timeout_minutes: 240  # 4 hours
      amdgpu_family: ${{ matrix.family_info.amdgpu_family }}
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: debug-tools (generic, parallel to math-libs)
  # ==========================================================================
  debug-tools:
    needs: compiler-runtime
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: debug-tools
      stage_display_name: "Stage - Debug Tools"
      timeout_minutes: 180  # 3 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: dctools-core (generic, parallel to math-libs)
  # ==========================================================================
  dctools-core:
    needs: compiler-runtime
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: dctools-core
      stage_display_name: "Stage - DC Tools Core"
      timeout_minutes: 120  # 2 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: profiler-apps (generic, parallel to math-libs)
  # ==========================================================================
  profiler-apps:
    needs: compiler-runtime
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: profiler-apps
      stage_display_name: "Stage - Profiler Apps"
      timeout_minutes: 180  # 3 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: media (generic)
  # ==========================================================================
  media:
    needs: foundation
    uses: ./.github/workflows/multi_arch_build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      stage_name: media
      stage_display_name: "Stage - Media"
      timeout_minutes: 180  # 3 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write
