name: Test External Repo Integration

# This workflow tests external repository CI integration by overriding the
# github.repository value that is normally used for repository detection.
#
# Automatically runs on PRs that modify CI infrastructure files.
#
# TODO: Add workflow_dispatch for manual testing with project/test filtering options

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
      - 'build_tools/github_actions/**'
      - 'build_tools/install_rocm_from_artifacts.py'
      - 'build_tools/fetch_artifacts.py'

permissions:
  contents: read

jobs:
  # Test rocm-libraries integration
  test-rocm-libraries:
    name: "Test rocm-libraries Integration"
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      therock_ref: ${{ github.ref }}
      repository_override: "ROCm/rocm-libraries"
      # Test with rocprim (fast build) to simulate a typical PR scenario
      projects: 'projects/rocprim'
      linux_amdgpu_families: "gfx94X-dcgpu"
      windows_amdgpu_families: "gfx110X-all"
    permissions:
      contents: read
      id-token: write

  # Test rocm-systems integration
  test-rocm-systems:
    name: "Test rocm-systems Integration"
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      therock_ref: ${{ github.ref }}
      repository_override: "ROCm/rocm-systems"
      # Test with clr (core component) to simulate a typical PR scenario
      projects: 'projects/clr'
      linux_amdgpu_families: "gfx94X-dcgpu"
      windows_amdgpu_families: "gfx110X-all"
    permissions:
      contents: read
      id-token: write
