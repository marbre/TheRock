name: CI - Linux

on:
  workflow_call:
    inputs:
      artifact_group:
        type: string
      amdgpu_families:
        type: string
      build_variant_label:
        type: string
      build_variant_cmake_preset:
        type: string
      build_variant_suffix:
        type: string
      test_labels:
        type: string
      artifact_run_id:
        type: string
      test_runs_on:
        type: string
      benchmark_runs_on:
        type: string
        default: ""
      expect_failure:
        type: boolean
      use_prebuilt_artifacts:
        type: string
      rocm_package_version:
        type: string
      test_type:
        type: string
      sanity_check_only_for_family:
        type: boolean
      external_source_checkout:
        type: boolean
        description: "Whether source is from external repo (rocm-libraries/systems)"
        default: false
      therock_ref:
        type: string
        description: "TheRock git ref to use (for external repos)"
        default: ""
      repository_override:
        type: string
        description: "Override github.repository for testing (e.g., 'ROCm/rocm-libraries')"
        default: ""
      cmake_options:
        type: string
        description: "Extra CMake options for external repo projects"
        default: ""
      project_to_test:
        type: string
        description: "Comma-separated list of projects to test (for external repos)"
        default: ""

permissions:
  contents: read

jobs:
  build_portable_linux_artifacts:
    name: Build Artifacts
    if: ${{ inputs.use_prebuilt_artifacts == 'false' }}
    uses: ./.github/workflows/build_portable_linux_artifacts.yml
    secrets: inherit
    with:
      artifact_group: ${{ inputs.artifact_group }}
      package_version: ${{ inputs.rocm_package_version }}
      amdgpu_families: ${{ inputs.amdgpu_families }}
      build_variant_label: ${{ inputs.build_variant_label }}
      build_variant_cmake_preset: ${{ inputs.build_variant_cmake_preset }}
      build_variant_suffix: ${{ inputs.build_variant_suffix }}
      expect_failure: ${{ inputs.expect_failure }}
      external_source_checkout: ${{ inputs.external_source_checkout }}
      therock_ref: ${{ inputs.therock_ref }}
      repository_override: ${{ inputs.repository_override }}
      extra_cmake_options: ${{ inputs.cmake_options }}
    permissions:
      contents: read
      id-token: write

  # TODO: rework "artifact_run_id" and "use_prebuilt_artifacts" here?
  #   I don't want to copy/paste this condition and special case plumbing
  #   through multiple workflows. All the packaging and testing workflows need
  #   to know is what artifact run id to use. That could be the current
  #   (implicit) run id, or it could be an explicit run id.
  #   How about having the "build artifacts" job run as a passthrough?

  test_linux_artifacts:
    needs: [build_portable_linux_artifacts]
    name: Test Artifacts
    # If the dependent job failed/cancelled, this job will not be run
    # The use_prebuilt_artifacts "or" statement ensures that tests will run if
    # previous build step is run or skipped.concurrency.
    # If we are expecting a build failure, do not run tests to save machine capacity
    if: >-
      ${{
        !failure() &&
        !cancelled() &&
        (
          inputs.use_prebuilt_artifacts == 'false' ||
          inputs.use_prebuilt_artifacts == 'true'
        ) &&
        inputs.expect_failure == false
      }}
    uses: ./.github/workflows/test_artifacts.yml
    with:
      artifact_group: ${{ inputs.artifact_group }}
      amdgpu_families: ${{ inputs.amdgpu_families }}
      test_runs_on: ${{ inputs.test_runs_on }}
      artifact_run_id: ${{ inputs.artifact_run_id }}
      test_type: ${{ inputs.test_type }}
      test_labels: ${{ inputs.test_labels }}
      project_to_test: ${{ inputs.project_to_test }}
      sanity_check_only_for_family: ${{ inputs.sanity_check_only_for_family == true }}
      therock_ref: ${{ inputs.therock_ref }}

  test_linux_benchmarks:
    needs: [build_portable_linux_artifacts]
    name: Test Linux Benchmarks
    # Run benchmarks if:
    # - Build succeeded (or using prebuilt artifacts)
    # - Not expecting failure
    # - Benchmark runner is available (benchmark_runs_on is set)
    if: >-
      ${{
        !failure() &&
        !cancelled() &&
        (
          inputs.use_prebuilt_artifacts == 'false' ||
          inputs.use_prebuilt_artifacts == 'true'
        ) &&
        inputs.expect_failure == false &&
        inputs.benchmark_runs_on != ''
      }}
    uses: ./.github/workflows/test_benchmarks.yml
    secrets: inherit
    with:
      artifact_group: ${{ inputs.artifact_group }}
      amdgpu_families: ${{ inputs.amdgpu_families }}
      test_runs_on: ${{ inputs.benchmark_runs_on }}
      artifact_run_id: ${{ inputs.artifact_run_id }}

  build_portable_linux_python_packages:
    needs: [build_portable_linux_artifacts]
    name: Build Python
    # If the dependent job failed/cancelled, this job will not be run
    # The use_prebuilt_artifacts "or" statement ensures that tests will run if
    # previous build step is run or skipped.concurrency.
    # Skip for external repos (they don't need Python packages)
    if: >-
      ${{
        !failure() &&
        !cancelled() &&
        (
          inputs.use_prebuilt_artifacts == 'false' ||
          inputs.use_prebuilt_artifacts == 'true'
        ) &&
        inputs.expect_failure == false &&
        inputs.external_source_checkout == false
      }}
    uses: ./.github/workflows/build_portable_linux_python_packages.yml
    with:
      artifact_run_id: "${{ inputs.artifact_run_id != '' && inputs.artifact_run_id || github.run_id }}"
      artifact_group: ${{ inputs.artifact_group }}
      package_version: ${{ inputs.rocm_package_version }}
